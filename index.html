<!DOCTYPE html>
<html>
	<head>
		<title>Visor de tracks</title>

		<!-- Required meta tags -->
		<meta charset="utf-8">
		<meta name="viewport" content="width=device-width, initial-scale=1">
    
		<link rel="stylesheet" href="css/leaflet.css" />
		<link rel="stylesheet" href="css/mycss.css" />
    	<link rel="stylesheet" href="css/bootstrap.css" />
		<script src="js/leaflet.js"></script>
    	<script src="js/bootstrap.js"></script>
		<script src="node_modules/chart.js/dist/chart.min.js"></script>

		<link rel="shortcut icon" type="image/x-icon" href="docs/images/favicon.ico" />		
	</head>
	<body>
		<!-- Fixed navbar -->
		<nav class="navbar col-sm-12 navbar-default navbar-fixed-top" style="background-color: gray; padding-left: 12px;padding-right: 12px; z-index: 999; position: fixed !important">
			<ul class="nav nav-pills nav-fill">
				<li class="nav-item">
					<input id="file-input" size="20" type="file" class="btn btn-primary btn-sm">
				</li>
				<li class="nav-item dropdown">
					<a id ="nombreMapa" class="nav-link dropdown-toggle" data-bs-toggle="dropdown" href="#" role="button" aria-expanded="false" style="color:white">Raster IGCC</a>
					<ul class="dropdown-menu">
						<li><a class="dropdown-item" id="RasterIGN" href="#" onclick="cambiaMapa(this.id)">Raster IGN</a></li>
						<li><a class="dropdown-item" id="BaseIGN" href="#" onclick="cambiaMapa(this.id)">IGN Base</a></li>
						<li><a class="dropdown-item" id="RasterICGC" onclick="cambiaMapa(this.id)" href="#">Raster ICGC</a></li>
						<li><a class="dropdown-item" id="OSM" onclick="cambiaMapa(this.id)" href="#">OpenStreetMaps</a></li>
					</ul>
				</li>
			<ul class="nav justify-content-end">
				<li class="nav-item">
					<div class="text-end" id="creador" style="color:white; padding-right: 0px;"></div>
				</li>
			</ul>
	  	</nav>
		<div class="container-fluid">
			<div class="row" style="margin-left: 0px; padding-left: 12px;padding-right: 12px;">
				<div class="col-sm-10" id="map" style="margin-top: 60px; height: 75vh;"></div>
				<div class="col-sm-2" id="colInfo">
					<div class="row"></div>
						<div style="height: 5vh; margin-left: 5px; font-weight: bold;" id="tituloInfo"></div>
					<div class="row" id="info" style="margin-left: 5px"></div>
				</div>	
			</div>
			<div class="row" style="margin-left: 0px;" id="perfilRuta">
			<!--	<div class="col-sm-12" id="grafica"></div>  -->
				<canvas id="perfil"></canvas>
			</div>
		</div>
		<script>
			// Variables globales
		    var nombre='';
		    var xml = new XMLHttpRequest();
			var ruta=[];
			var elevacionX=[];
			var elevacionY=[];
			var map = L.map('map').setView([41.125, 1.238], 10);
			L.tileLayer.wms('http://www.ign.es/wms-inspire/mapa-raster', {
				layers: 'mtn_rasterizado',
				format: 'image/png',
				transparent: false,
				continuousWorld : true,
				attribution: '© <a href="http://www.ign.es/ign/main/index.do" target="_blank">Instituto Geográfico Nacional de España</a>'
			}).addTo(map);

			L.control.scale({imperial:false}).addTo(map);
			var grupoCapas = L.layerGroup().addTo(map);
			var marcadorPosicion = L.layerGroup().addTo(map);
			var iconosSize=[25,41];	
			var perfilRuta=null;     
			// FIN Varianbles locales 	
			
			// Eventos
			map.on('click', onMapClick);

			/*
			var button = document.getElementById("file-input");
			button.addEventListener('click', leerArchivo, false);

			button.onclick = function(){
				console.log(this.id+": Clicked!");
				leerArchivo();
			}
			*/

			document.getElementById('file-input')
			.addEventListener('change', leerArchivo, false);	

			// FIN Eventos

			// Creo los iconos
			var iSalida = L.icon({
				iconUrl: 'images/start.png',
				//  shadowUrl: 'leaf-shadow.png',

				iconSize:     iconosSize, // size of the icon
				//shadowSize:   [50, 64], // size of the shadow
				//iconAnchor:   [22, 94], // point of the icon which will correspond to marker's location
				//shadowAnchor: [4, 62],  // the same for the shadow
				//popupAnchor:  [-3, -76] // point from which the popup should open relative to the iconAnchor
			});

			var iLlegada = L.icon({
				iconUrl: 'images/racing-flag.png',
				//  shadowUrl: 'leaf-shadow.png',
				iconSize:    iconosSize, // size of the icon
				//shadowSize:   [50, 64], // size of the shadow
				//iconAnchor:   [22, 94], // point of the icon which will correspond to marker's location
				//shadowAnchor: [4, 62],  // the same for the shadow
				//popupAnchor:  [-3, -76] // point from which the popup should open relative to the iconAnchor
			});

			var iMarcador = L.icon({
				iconUrl: 'images/marker-icon.png',
				//  shadowUrl: 'leaf-shadow.png',
				//iconSize:    iconosSize, // size of the icon
				//shadowSize:   [50, 64], // size of the shadow
				//iconAnchor:   [22, 94], // point of the icon which will correspond to marker's location
				//shadowAnchor: [4, 62],  // the same for the shadow
				//popupAnchor:  [-3, -76] // point from which the popup should open relative to the iconAnchor
			});	
			
			var iWayPoint = L.icon({
				iconUrl: 'images/gps.png',
				//  shadowUrl: 'leaf-shadow.png',
				iconSize:    iconosSize, // size of the icon
				//shadowSize:   [50, 64], // size of the shadow
				//iconAnchor:   [22, 94], // point of the icon which will correspond to marker's location
				//shadowAnchor: [4, 62],  // the same for the shadow
				//popupAnchor:  [-3, -76] // point from which the popup should open relative to the iconAnchor
			});	
			// FIN Creo los iconos

			/*
	      	// Poner un marcador en el mapa
	      	L.marker([41.124302580367235, 1.2385328405983511]).addTo(map)
				    .bindPopup('Hospital Universitario Joan XXIII.')
				    .openPopup();
			*/

			//Funciones
			function cambiaMapa(mapa){
				// Creo un array para guardar las layers para poder borrarlas luego
				var layers = [];
				var OSM = L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
					id: 'MapOSM', 
					attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
				});
				layers.push(OSM);
   				var	RasterICGC = L.tileLayer('https://geoserveis.icgc.cat/icc_mapesmultibase/noutm/wmts/topo/GRID3857/{z}/{x}/{y}.jpeg', {
					id: 'MapRasterICGC', 
					attribution: '&copy; <a href="https://creativecommons.org/licenses/by/4.0/deed.ca">ICGC under CC BY 4.0</a> contributors'
				});
				layers.push(RasterICGC);
				var RasterIGN = L.tileLayer.wms('http://www.ign.es/wms-inspire/mapa-raster', {
					layers: 'mtn_rasterizado',
					format: 'image/png',
					transparent: false,
					continuousWorld : true,
					attribution: '© <a href="http://www.ign.es/ign/main/index.do" target="_blank">Instituto Geográfico Nacional de España</a>'
				});
				layers.push(RasterIGN);

				var BaseIGN=L.tileLayer.wms('http://www.ign.es/wms-inspire/ign-base', {
					layers: 'IGNBaseTodo',
					format: 'image/png',
					transparent: false,
					continuousWorld : true,
					attribution: '© <a href="http://www.ign.es/ign/main/index.do" target="_blank">Instituto Geográfico Nacional de España</a>'
				});
				layers.push=(BaseIGN);

				for(i=0;i<layers.length;i++){
					map.removeLayer(layers[i]);
				}
/*
				if (mapa == "OSM"){
					document.getElementById('nombreMapa').innerHTML='OpenStreetMaps';
					map.addLayer(OSM);
				}
				if (mapa == "RasterICGC"){
					document.getElementById('nombreMapa').innerHTML='Raster ICGC';
					map.addLayer(RasterICGC);
				}
				if (mapa == "RasterIGN"){
					document.getElementById('nombreMapa').innerHTML='Raster IGN';
					map.addLayer(RasterIGN);
				}
*/
				switch (mapa){
					case 'OSM':
						document.getElementById('nombreMapa').innerHTML='OpenStreetMaps';
						map.addLayer(OSM);
						break;
					case 'RasterICGC':
						document.getElementById('nombreMapa').innerHTML='Raster ICGC';
						map.addLayer(RasterICGC);
						break;
					case 'RasterIGN':
						document.getElementById('nombreMapa').innerHTML='Raster IGN';
						map.addLayer(RasterIGN);
						break;
					case 'BaseIGN':
					document.getElementById('nombreMapa').innerHTML='IGN Base';
						map.addLayer(BaseIGN);
						break;

				}


			}

			function onMapClick(e) { // Dibuja un marker en la posicion clickada
				marcadorPosicion.clearLayers();
				var posicionMarcador = e.latlng;
				var posicionMarcadorTxt = e.latlng.lat+', '+e.latlng.lng;
				L.marker(posicionMarcador,{icon: iMarcador}).addTo(marcadorPosicion)
					.bindPopup(posicionMarcadorTxt)
					.openPopup();
			}

			function leerArchivo(e) { // Abre el selector de ficheros para cargar la ruta
				var archivo = e.target.files[0];
				if (!archivo) {
				return;
				}
				nombre=archivo.name;
				nombre = "tracks/"+nombre;
				loadDoc(nombre);
			}

			function loadDoc(nombre){ // Abre el fichero de la ruta seleccionada
				xml.open("GET", nombre, false);
				xml.send();
			
				var xmlDoc = xml.responseXML;
				creador(xmlDoc); 				// Busca el creador de la ruta
				buscaEstadisticas(xmlDoc);		// Busca las estadisticas de la ruta
				cargaRuta(xmlDoc);				// Crea los arrays con los datos de la ruta
				dibujaRuta(ruta);				// Dibuja la ruta en el mapa
				wayPoints(xmlDoc);				// Dubuja los waypoints en el mapa
				if (perfilRuta != null){
					// Borra los adtos anteriores

					// Borra la grafica anterior
					// Primero elimino el canvas
					const para = document.createElement('canvas');
					para.id = 'perfil';
					var parent = document.getElementById('perfilRuta');
					var tag = document.getElementById('perfil');
					tag.remove();
					perfilRuta.destroy();			// Borro la grafica anterior
					parent.appendChild(para);		// Vuelvo a crear el canvas
				}

				graficaElevacion();				// Dibuja la grafica del perfil de la ruta

			}

			function clearMap() { // Limpia el mapa de todos los elementos de la ruta anterior
				grupoCapas.clearLayers();
				for(i in map._layers) {
					if(map._layers[i]._path != undefined) {
						try {
							map.removeLayer(map._layers[i]);
						}
						catch(e) {
							console.log("problem with " + e + map._layers[i]);
						}
					}
				}
			}	
		
			function creador(xmlDoc){ // Busca el creador de la ruta
				var x = xmlDoc.getElementsByTagName("gpx"); 
				var creador = x[0].attributes['creator'].value;
				document.getElementById("creador").innerHTML="Creado por: "+creador;
			}

			function buscaEstadisticas(xmlDoc){ // Busca las estadisticas de la ruta
				var _info = document.getElementById('info');
				var _tituloInfo = document.getElementById('tituloInfo');
				try{
					// Busca los tags "desc"
					var x=xmlDoc.getElementsByTagName("desc");	  	
					var info=x[1].childNodes[0].nodeValue;
					_tituloInfo.innerHTML="Estadistica track";
					_info.innerHTML='<FONT SIZE=2>'+info+'</font>';
				} catch(e){
					// Si no los encuentra
					_tituloInfo.innerHTML='';
					_info.innerHTML='';
				}	
			}
	
			function cargaRuta(xmlDoc){	// Crea los arrays con los datos de la ruta
				var x=xmlDoc.getElementsByTagName("trkpt");
				var latlang = [];
				var ele = [];
				// Vacio los arrays de la grafica del perfil para evitar que las graficas se acumulen.
				elevacionX=[];
				elevacionY=[];
				for (i=0;i<x.length;i++){     
					var arraytemp = [x[i].attributes['lat'].value, x[i].attributes['lon'].value]
					latlang.push(arraytemp);
				//	if (i%60 == 0){ // Coge la elevación cada minuto
						elevacionY.push(x[i].getElementsByTagName('ele')[0].textContent);
						elevacionX.push(i);
					}
				ruta=latlang;
			}

			function dibujaRuta(ruta){  // Dibuja la ruta en el mapa
				var salida = ruta[0];  
				var llegada = ruta[ruta.length-1];  
				clearMap();
				// Mueve el mapa a la salida de la ruta
				map.setView(salida, 12);
				
				// Dibuja la ruta
				var polyLineOptions = {color:'red'};
				var polyLine = L.polyline(ruta , polyLineOptions);
				//polyLine.addTo(map);
				polyLine.addTo(grupoCapas);
				L.marker(salida, {icon: iSalida}).addTo(grupoCapas);
				L.marker(llegada, {icon: iLlegada}).addTo(grupoCapas);	 
			}

			function wayPoints(xmlDoc){ // Dubuja los waypoints en el mapa
				var x=xmlDoc.getElementsByTagName("wpt");
				for(i=0;i<x.length;i++){
					try{
						var tipo = x[i].getElementsByTagName('type')[0].textContent;
					} catch {
						tipo='';
					}
					if (tipo != 'Comienzo' && tipo != 'Final'){
						var nombre = x[i].getElementsByTagName('name')[0].textContent;
						var arraytemp = [x[i].attributes['lat'].value, x[i].attributes['lon'].value,x[i]];
						L.marker(arraytemp,{icon:iWayPoint}).addTo(grupoCapas)
							.bindPopup(nombre)
							.openPopup();
					}
				}
			}

			function graficaElevacion(){ 

	/*			// Borra la grafica anterior
				const para = document.createElement('canvas');
				para.id = 'perfil';
				var parent = document.getElementById('perfilRuta');
				var tag = document.getElementById('perfil');
				tag.remove();


				if (perfilRuta != null){
					alert("Borro el perfil");
					console.log(perfilRuta);
					perfilRuta.destroy();
					console.log(perfilRuta);
				}



				parent.appendChild(para);

*/
				var perfil = document.getElementById("perfil").getContext('2d');
				perfil.canvas.width = screen.width;
				perfil.canvas.height = 150;
				perfilRuta = new Chart(perfil, {
					type: 'line',
					data: {
						labels:elevacionX,
						datasets: [{
							label: 'Altura',
							data: elevacionY,
							fill : true,
							lineTension: 0.3,
							backgroundColor: "rgba(2,117,216,0.2)",
							borderColor: "rgba(2,117,216,1)",
							pointRadius: 0,
							pointBackgroundColor: "rgba(2,117,216,1)",
							pointBorderColor: "rgba(255,255,255,0.8)",
							pointHoverRadius: 5,
							pointHoverBackgroundColor: "rgba(2,117,216,1)",
							pointHitRadius: 50,
							pointBorderWidth: 2,
							borderWidth: 1
						}]
					},
					options: {
					    tooltips: {
					         enabled: false
					    },
						scales: {
							xAxes: {
								display: false,
								scaleLabel: {
								display: false,
								labelString: 'Tiempo'
								}
							},
							yAxes:{
								display: true,
								scaleLabel: {
								display: true,
								labelString: 'Elevacion'
								}
							}
						},
						plugins: {
							title: {
								display: true,
								text: 'Perfil Ruta',
							},
							legend: {
								display: false
							}
						}
					}
				});
			}
			//Funciones
		</script>
	</body>
</html>