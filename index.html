<!DOCTYPE html>
<html>
	<head>
		<title>Visod de tracks</title>

		<!-- Required meta tags -->
		<meta charset="utf-8">
		<meta name="viewport" content="width=device-width, initial-scale=1">
    
		<link rel="stylesheet" href="css/leaflet.css" />
		<link rel="stylesheet" href="css/mycss.css" />
    	<link rel="stylesheet" href="css/bootstrap.css" />
		<script src="js/leaflet.js"></script>
    	<script src="js/bootstrap.js"></script>
		<script src="js/plotly-2.8.3.min.js"></script>
		<link rel="shortcut icon" type="image/x-icon" href="docs/images/favicon.ico" />		
	</head>
	<body>
		<div class="container-fluid" >
			<div class="row" style="margin-top: 05px;padding-top: 5px;padding-bottom: 5px;margin-bottom: 5px;">
				<div class="col-sm-7" id="menu">
					<input id="file-input" size="20" type="file"></div>
				<div class="col-sm-3 text-end" id="creador" style="padding-right: 0px;"></div>
				<div class="col-sm-2 text-center" id="tituloInfo" style="padding-right: 0px;"></div>
			</div>
			<div class="row" style="height: 75vh;margin-left: 0px;">
				<div class="col-sm-10" id="map" ></div>
				<div class="col-sm-2" id="info"></div>	
			</div>
			<div class="row" style="height: 20vh;margin-left: 0px;">
				<div class="col-sm-10" id="map" id="grafica"></div>
			</div>
		</div>
		<script>
		    var nombre='';
		    var xml = new XMLHttpRequest();
			var ruta=[];
			var elevacion=[];
			var map = L.map('map').setView([41.125, 1.238], 13);
			L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
				maxZoom: 18,
			    attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
			}).addTo(map);
			L.control.scale({imperial:false}).addTo(map);
			var grupoCapas = L.layerGroup().addTo(map);
			var marcadorPosicion = L.layerGroup().addTo(map);
	      	
			// Creo los iconos
			var iconosSize=[25,41];
			var iSalida = L.icon({
				iconUrl: 'images/start.png',
				//  shadowUrl: 'leaf-shadow.png',

				iconSize:     iconosSize, // size of the icon
				//shadowSize:   [50, 64], // size of the shadow
				//iconAnchor:   [22, 94], // point of the icon which will correspond to marker's location
				//shadowAnchor: [4, 62],  // the same for the shadow
				//popupAnchor:  [-3, -76] // point from which the popup should open relative to the iconAnchor
			});

			var iLlegada = L.icon({
				iconUrl: 'images/racing-flag.png',
				//  shadowUrl: 'leaf-shadow.png',
				iconSize:    iconosSize, // size of the icon
				//shadowSize:   [50, 64], // size of the shadow
				//iconAnchor:   [22, 94], // point of the icon which will correspond to marker's location
				//shadowAnchor: [4, 62],  // the same for the shadow
				//popupAnchor:  [-3, -76] // point from which the popup should open relative to the iconAnchor
			});

			var iMarcador = L.icon({
				iconUrl: 'images/marker-icon.png',
				//  shadowUrl: 'leaf-shadow.png',
				//iconSize:    iconosSize, // size of the icon
				//shadowSize:   [50, 64], // size of the shadow
				//iconAnchor:   [22, 94], // point of the icon which will correspond to marker's location
				//shadowAnchor: [4, 62],  // the same for the shadow
				//popupAnchor:  [-3, -76] // point from which the popup should open relative to the iconAnchor
			});	
			
			var iWayPoint = L.icon({
				iconUrl: 'images/gps.png',
				//  shadowUrl: 'leaf-shadow.png',
				iconSize:    iconosSize, // size of the icon
				//shadowSize:   [50, 64], // size of the shadow
				//iconAnchor:   [22, 94], // point of the icon which will correspond to marker's location
				//shadowAnchor: [4, 62],  // the same for the shadow
				//popupAnchor:  [-3, -76] // point from which the popup should open relative to the iconAnchor
			});	
			
			/*
	      	// Poner un marcador en el mapa
	      	L.marker([41.124302580367235, 1.2385328405983511]).addTo(map)
				    .bindPopup('Hospital Universitario Joan XXIII.')
				    .openPopup();
			*/

			// Eventos
			map.on('click', onMapClick);

		    document.getElementById('file-input')
		      .addEventListener('change', leerArchivo, false);			

			function onMapClick(e) {
				marcadorPosicion.clearLayers();
			    var posicionMarcador = e.latlng;
				var posicionMarcadorTxt = e.latlng.lat+', '+e.latlng.lng;
				L.marker(posicionMarcador,{icon: iMarcador}).addTo(marcadorPosicion)
					.bindPopup(posicionMarcadorTxt)
					.openPopup();
				/*
				var posicion = 'Posici√≥n: '+e.latlng.lat+', '+e.latlng.lng;
				document.getElementById("latLang").innerHTML=posicion;
				*/
			}

	        function leerArchivo(e) {
		        var archivo = e.target.files[0];
		        if (!archivo) {
		          return;
		        }
		        nombre=archivo.name;
		        nombre = "tracks/"+nombre;
		        loadDoc(nombre);
		    }

		    function loadDoc(nombre){
	      		xml.open("GET", nombre, false);
		      	xml.send();
		    
			  	var xmlDoc = xml.responseXML;
				creador(xmlDoc);
				buscaEstadisticas(xmlDoc);
				cargaRuta(xmlDoc);
				console.log(ruta);
				dibujaRuta(ruta);
				wayPoints(xmlDoc);
		    }

		    function clearMap() {
		   		grupoCapas.clearLayers();
			    for(i in map._layers) {
			        if(map._layers[i]._path != undefined) {
			            try {
			                map.removeLayer(map._layers[i]);
			            }
			            catch(e) {
			                console.log("problem with " + e + map._layers[i]);
			            }
			        }
			    }
			}	
		
			function creador(xmlDoc){
				// Mira el creador de la ruta
				var x = xmlDoc.getElementsByTagName("gpx"); 
				var creador = x[0].attributes['creator'].value;
				document.getElementById("creador").innerHTML="Creado por: "+creador;
			}

			function buscaEstadisticas(xmlDoc){
				// Mira si hay estadisticas de la ruta
				try{
				  	var x=xmlDoc.getElementsByTagName("desc");	  	
					var info=x[1].childNodes[0].nodeValue;
					document.getElementById('tituloInfo').innerHTML="Estadistica track";
					document.getElementById('info').innerHTML='<FONT SIZE=2>'+info+'</font>';
				} catch(e){
					document.getElementById('tituloInfo').innerHTML='';
					document.getElementById('info').innerHTML='';
				}	
			}
	
			function cargaRuta(xmlDoc){
				var x=xmlDoc.getElementsByTagName("trkpt");
		    	var latlang = [];
			  	for (i=0;i<x.length;i++){     
				    var arraytemp = [x[i].attributes['lat'].value, x[i].attributes['lon'].value]
				    latlang.push(arraytemp);
				}
				ruta= latlang;
			}

			function dibujaRuta(ruta){
				var salida = ruta[0];  
				var llegada = ruta[ruta.length-1];  
			  	clearMap();
				// Mueve el mapa a la salida de la ruta
				map.setView(salida, 12);
				
				// Dibuja la ruta
				var polyLineOptions = {color:'red'};
	        	var polyLine = L.polyline(ruta , polyLineOptions);
	        	//polyLine.addTo(map);
	        	polyLine.addTo(grupoCapas);
	        	L.marker(salida, {icon: iSalida}).addTo(grupoCapas);
	        	L.marker(llegada, {icon: iLlegada}).addTo(grupoCapas);	 
			}

			function wayPoints(xmlDoc){
				// Dibuja los WP en el mapa
				var x=xmlDoc.getElementsByTagName("wpt");
				for(i=0;i<x.length;i++){
					try{
						var tipo = x[i].getElementsByTagName('type')[0].textContent;
					} catch {
						tipo='';
					}
					if (tipo != 'Comienzo' && tipo != 'Final'){
						var nombre = x[i].getElementsByTagName('name')[0].textContent;
						var arraytemp = [x[i].attributes['lat'].value, x[i].attributes['lon'].value,x[i]];
						L.marker(arraytemp,{icon:iWayPoint}).addTo(grupoCapas)
							.bindPopup(nombre)
							.openPopup();
					}
				}
			}
		</script>
	</body>
</html>