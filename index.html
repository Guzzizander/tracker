<!DOCTYPE html>
<html>
	<head>
		<title>Visor de tracks</title>

		<!-- Required meta tags -->
		<meta charset="utf-8">
		<meta name="viewport" content="width=device-width, initial-scale=1">
    
		<!-- <link rel="stylesheet" href="css/leaflet.css" /> -->

		<link rel="stylesheet" href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css"
			integrity="sha512-xodZBNTC5n17Xt2atTPuE1HxjVMSvLVW9ocqUKLsCC5CXdbqCmblAshOMAS6/keqq/sMZMZ19scR4PsZChSR7A=="
			crossorigin=""/>
		<link rel="stylesheet" href="css/leaflet.draw.css" />
		<link rel="stylesheet" href="css/Control.OSMGeocoder.css" />
		<link rel="stylesheet" href="css/mycss.css" />
    	<link rel="stylesheet" href="css/bootstrap.css" />

		<script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js"
		integrity="sha512-XQoYMqMTK8LvdxXYG3nZ448hOEQiglfqkJs1NOQV44cWnUrBc8PkAOcXy20w0vlaXaVUearIOBhiXZ5V3ynxwA=="
		crossorigin=""></script>
		<script src="js/Control.OSMGeocoder.js"></script>
		<script src="js/tracks.js"></script>
    	<script src="js/bootstrap.js"></script>
		<script src="js/chart.min.js"></script>
		<link rel="shortcut icon" type="image/x-icon" href="docs/images/favicon.ico" />	
	</head>
	<body>
		<!-- Fixed navbar -->
		<nav class="navbar col-sm-12 navbar-default navbar-fixed-top" style="background-color: gray; padding-left: 12px;padding-right: 12px; z-index: 999; position: fixed !important">
			<ul class="nav nav-pills nav-fill justify-content-start">
				<div class="text-end" id="nombreFichero" style="color:white; padding-right: 0px;"></div>
			</ul>
			<ul class="nav nav_pills nav_fill justify-content-end">
				<div class="text-end" id="creador" style="color:white; padding-right: 0px;"></div>
			</ul>
	  	</nav>
		<div class="container-fluid">
			<div class="row" style="margin-left: 0px; padding-left: 12px;padding-right: 12px;">
				<div class="col-sm-10" id="map" style="margin-top: 60px; height: 75vh;"></div>
				<div class="col-sm-2" id="colInfo" style="margin-top: 60px; height: 75vh;">
					<div class="row"></div>
						<div style="height: 5vh; margin-left: 5px; font-weight: bold;" id="tituloInfo"></div>
					<div class="row" id="info" style="margin-left: 5px"></div>
				</div>	
			</div>
			<div class="row" style="margin-left: 0px;" id="divPerfil">
			<!--	<div class="col-sm-12" id="grafica"></div>  -->
				<canvas id="canvasPerfil"></canvas>
			</div>
		</div>
		<script>
			// Constantes configuracion modulos
			const DRAW=false;
			const GEOLOCALIZADOR=true;
			const CARGAFICHERO=true;

			// Variables globales
		    var nombre='';
		    var xml = new XMLHttpRequest();
			// FIN Variables locales 	

			// Definicion mapa Leaflet		
			var map = L.map('map',{
				zoomControl:true,
				maxZoom:22,
				layers:[RasterIGN]
				}).setView([41.125, 1.238], 10);

			var ruta=[];
			var elevacionX=[];
			var elevacionY=[];
			var capaRuta = L.layerGroup().addTo(map);
			var capaIconos = L.layerGroup().addTo(map);
			var capaPosiciones = L.layerGroup().addTo(map);
			var iconosSize=[25,41];	
			var perfilElevacion=null;

			var baselayers = {
				"Orotofoto IGN": OrtofotoIGN,
				"Raster IGN": RasterIGN,
				"IGN Base": BaseIGN,
				"Raster ICGC": RasterICGC,
				"OpenStreetMaps": OSM,
				"OpenTopomap" : otmUrl
			};

			var overlays = {
				"Ruta": capaRuta,
				"Iconos": capaIconos,
				"Posiciones":capaPosiciones
			}
			
			L.control.scale({imperial:false}).addTo(map);	

			if (CARGAFICHERO){
			// Carga de fichero desde el icono					
				var cargaFichero = L.control({
					position: 'topright'
				});

				cargaFichero.onAdd = function(map) {
					// var thisLoader = this.loader;   // NO FUNCIONA
					// Creacion del boton y enlazarlo con in input-file oculto
					var zoomName = 'leaflet-control';
					var barName = 'leaflet-bar';
					var partName = barName + '-part';
					var container = L.DomUtil.create('div', zoomName + ' ' + barName);
					var link = L.DomUtil.create('a', zoomName +' '+ partName, container);
					//link.innerHTML = L.Control.FileLayerLoad.LABEL;
					link.innerHTML = '<img class="icon" src="css/images/folder.svg" alt="file icon"/>';
					link.href = '#';
					//link.title = L.Control.FileLayerLoad.TITLE;
					link.title = "Carga ficheros";

					// Creacion del input-file oculto
					fileInput=L.DomUtil.create('input','hidden',container);
					fileInput.type='file';
					fileInput.multiple='multiple';
					fileInput.accept='.gpx';
					fileInput.style.display='none';
					// Cargar on file change
					/*
					fileInput.addEventListener('change',function(){
						thisLoader.loadMultipe(this.files);
						// reset para poder cargar el mismo fichero varias veces
						this.value='';
					}, false);
					*/
					L.DomEvent.disableClickPropagation(link);
					L.DomEvent.on(link, 'click', function (e) {
						fileInput.click();
						e.preventDefault();
					});					
					return container;
				}
				cargaFichero.addTo(map);

				fileInput.addEventListener("change", handleFiles, false);

				function handleFiles() {
					var fileList = this.files;
					for (var i=0;i<fileList.length;i++){
						var fileType = /gpx.*/;
						var file = fileList[i];

						if (!file.type.match(fileType)) {
						continue;
						}
						document.getElementById('nombreFichero').innerHTML=file.name;
						var reader = new FileReader();
						reader.readAsText(file);
						reader.onloadend = function(event){

							var xmlData = reader.result;  // aqui esta el XML
							if (typeof xmlData === 'string') {
								xmlData = (new window.DOMParser()).parseFromString(xmlData, 'text/xml');
							}
							leerXML(xmlData);
						};
					}
				}
			}

			// Controles para dibujar directamente en el mapa
			if (DRAW){
				var drawnItems = new L.FeatureGroup();
				map.addLayer(drawnItems);
				
				var drawControl = new L.Control.Draw({
				edit: {
					featureGroup: drawnItems
					}
				});
				map.addControl(drawControl);

				map.on('draw:created', function (e) {
					var type = e.layerType,
						layer = e.layer;
					drawnItems.addLayer(layer);
				});
			}

			// Geolocalizador
			if (GEOLOCALIZADOR){
				var osmGeocoder = new L.Control.OSMGeocoder({
				//collapsed: false,
				//position: 'bottomright',
				text: 'Buscar',
				});
				map.addControl(osmGeocoder);
			}

			var layerswitcher=L.control.layers(baselayers,overlays).addTo(map);

			// FIN Definicion mapa Leaflet
			
			// Eventos
			map.on('click', onMapClick);
			// FIN Eventos

			// Creo los iconos
			var iSalida = L.icon({
				iconUrl: 'css/images/start.png',
				iconSize:     iconosSize, // size of the icon				
				//  shadowUrl: 'leaf-shadow.png',
				//shadowSize:   [50, 64], // size of the shadow
				//iconAnchor:   [22, 94], // point of the icon which will correspond to marker's location
				//shadowAnchor: [4, 62],  // the same for the shadow
				//  shadowUrl: 'leaf-shadow.png',
				//popupAnchor:  [-3, -76] // point from which the popup should open relative to the iconAnchor
			});

			var iLlegada = L.icon({
				iconUrl: 'css/images/racing-flag.png',
				iconSize:    iconosSize, // size of the icon
			});

			var iMarcador = L.icon({
				iconUrl: 'css/images/marker-icon.png',
			});	
			
			var iWayPoint = L.icon({
				iconUrl: 'images/gps.png',
				iconSize:    iconosSize, // size of the icon
			});	
			// FIN Creo los iconos

			//Funciones
			function onMapClick(e) { // Dibuja un marker en la posicion clickada
				//capaPosiciones.clearLayers();
				var posicionMarcador = e.latlng;
				var posicionMarcadorTxt = e.latlng.lat+', '+e.latlng.lng;
				L.marker(posicionMarcador,{icon: iMarcador}).addTo(capaPosiciones)
					.bindPopup(posicionMarcadorTxt)
					.openPopup();
			}

			function leerXML(xml){ // Abre el fichero de la ruta seleccionada
				var xmlDoc = xml;
				//console.log(xmlDoc);
				creador(xmlDoc); 				// Busca el creador de la ruta
				buscaEstadisticas(xmlDoc);		// Busca las estadisticas de la ruta
				cargaRuta(xmlDoc);				// Crea los arrays con los datos de la ruta
				dibujaRuta(ruta);				// Dibuja la ruta en el mapa
				wayPoints(xmlDoc);				// Dubuja los waypoints en el mapa
				borraPerfil();
				graficaElevacion();				// Dibuja la grafica del perfil de la ruta

			}

			function borraPerfil(){				// Borra la grafica del perfil anterior
				if (perfilElevacion != null){
					console.log("Borrando grafica anterior");
					
					// Primero elimino el canvas
					const para = document.createElement('canvasPerfil');
					//para.id = 'canvasPerfil';
					var parent = document.getElementById('divPerfil');
					perfilElevacion.destroy();		// Borro la grafica anterior					
					var tag = document.getElementById(para.id);
					tag.remove();		// Borro el canvas
					parent.appendChild(para);		// Vuelvo a crear el canvas
					
				}				
			}

			function clearMap() { // Limpia el mapa de todos los elementos de la ruta anterior
				capaRuta.clearLayers();
				capaIconos.clearLayers();
				for(i in map._layers) {
					if(map._layers[i]._path != undefined) {
						try {
							map.removeLayer(map._layers[i]);
						}
						catch(e) {
							console.log("problem with " + e + map._layers[i]);
						}
					}
				}
			}	
		
			function creador(xmlDoc){ // Busca el creador de la ruta
				var x = xmlDoc.getElementsByTagName("gpx"); 
				var creador = x[0].attributes['creator'].value;
				document.getElementById("creador").innerHTML="Creado por: "+creador;
			}

			function buscaEstadisticas(xmlDoc){ // Busca las estadisticas de la ruta
				var _info = document.getElementById('info');
				var _tituloInfo = document.getElementById('tituloInfo');
				try{
					// Busca los tags "desc"
					var x=xmlDoc.getElementsByTagName("desc");	  	
					var info=x[1].childNodes[0].nodeValue;
					_tituloInfo.innerHTML="Estadistica track";
					_info.innerHTML='<FONT SIZE=2>'+info+'</font>';
				} catch(e){
					// Si no los encuentra
					_tituloInfo.innerHTML='';
					_info.innerHTML='';
				}	
			}
	
			function cargaRuta(xmlDoc){	// Crea los arrays con los datos de la ruta
				var x=xmlDoc.getElementsByTagName("trkpt");
				var latlang = [];
				var ele = [];
				// Vacio los arrays de la grafica del perfil para evitar que las graficas se acumulen.
				elevacionX=[];
				elevacionY=[];
				for (i=0;i<x.length;i++){     
					var arraytemp = [x[i].attributes['lat'].value, x[i].attributes['lon'].value]
					latlang.push(arraytemp);
				//	if (i%60 == 0){ // Coge la elevación cada minuto
						elevacionY.push(x[i].getElementsByTagName('ele')[0].textContent);
						elevacionX.push(i);
					}
				ruta=latlang;
			}

			function dibujaRuta(ruta){  // Dibuja la ruta en el mapa
				var salida = ruta[0];  
				var llegada = ruta[ruta.length-1];  
				clearMap();
				// Mueve el mapa a la salida de la ruta
				map.setView(salida, 12);
				
				// Dibuja la ruta
				var polyLineOptions = {
					color:'red',
	                weight: 5
				};
				var polyLine = L.polyline(ruta , polyLineOptions);
				
				polyLine.addTo(capaRuta);

				// Para poner la ruta en el desplegable de los oveerlays.
				/*
				var capa=capaRuta.addLayer(polyLine);
				layerswitcher.addOverlay(capa,nombreFichero);
				   console.log(capa._leaflet_id); 
				   console.log(capa);

				map.removeLayer(capa);  // Esto la hace no visible pero el overlay no se borra
				*/

				L.marker(salida, {icon: iSalida}).addTo(capaIconos);
				L.marker(llegada, {icon: iLlegada}).addTo(capaIconos);	 

				map.fitBounds(polyLine.getBounds());
			}

			function wayPoints(xmlDoc){ // Dubuja los waypoints en el mapa
				var x=xmlDoc.getElementsByTagName("wpt");
				for(i=0;i<x.length;i++){
					try{
						var tipo = x[i].getElementsByTagName('type')[0].textContent;
					} catch {
						tipo='';
					}
					if (tipo != 'Comienzo' && tipo != 'Final'){
						var nombre = x[i].getElementsByTagName('name')[0].textContent;
						var arraytemp = [x[i].attributes['lat'].value, x[i].attributes['lon'].value,x[i]];
						L.marker(arraytemp,{icon:iWayPoint}).addTo(capaIconos)
							.bindPopup(nombre)
							.openPopup();
					}
				}
			}

			function graficaElevacion(){ 
				var perfil = document.getElementById("canvasPerfil").getContext('2d');
				perfil.canvas.width = screen.width;
				perfil.canvas.height = 150;
				perfilRuta = new Chart(perfil, {
					type: 'line',
					data: {
						labels:elevacionX,
						datasets: [{
							label: 'Altura',
							data: elevacionY,
							fill : true,
							lineTension: 0.3,
							backgroundColor: "rgba(2,117,216,0.2)",
							borderColor: "rgba(2,117,216,1)",
							pointRadius: 0,
							pointBackgroundColor: "rgba(2,117,216,1)",
							pointBorderColor: "rgba(255,255,255,0.8)",
							pointHoverRadius: 5,
							pointHoverBackgroundColor: "rgba(2,117,216,1)",
							pointHitRadius: 50,
							pointBorderWidth: 2,
							borderWidth: 1
						}]
					},
					options: {
					    tooltips: {
					         enabled: false
					    },
						scales: {
							xAxes: {
								display: false,
								scaleLabel: {
								display: false,
								labelString: 'Tiempo'
								}
							},
							yAxes:{
								display: true,
								scaleLabel: {
								display: true,
								labelString: 'Elevacion'
								}
							}
						},
						plugins: {
							title: {
								display: true,
								text: 'Perfil Ruta',
							},
							legend: {
								display: false
							}
						}
					}
				});
			}  // FIN graficaElevacion
			//Funciones
		</script>
	</body>
</html>